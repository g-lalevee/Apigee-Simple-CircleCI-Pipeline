version: 2.1

jobs:
  deploy_apigee:
    docker:
      - image: maven:latest
    environment:
      API_VERSION: "googleapi"
      DEFAULT_APIGEE_ENV: default-dev
      DEFAULT_APIGEE_ORG: bap-emea-apigee-5
      AUTHOR_EMAIL: popo@popo.com
      GIT_BRANCH: main
      APIGEE_DEPLOYMENT_SUFFIX: ""
    steps:
      - checkout
      - run:
          name: setup-environment
          command: |
            # Main branch for Apigee test environment
            if [ $CIRCLE_BRANCH == "main" ]; then
                APIGEE_DEPLOYMENT_SUFFIX=""
                APIGEE_ENV="$DEFAULT_APIGEE_ENV"
                APIGEE_ORG="$DEFAULT_APIGEE_ORG"
            # Prod branch for Apigee prod environment
            else
              if [ $CIRCLE_BRANCH == "prod" ]; then
                APIGEE_DEPLOYMENT_SUFFIX=""
                APIGEE_ENV="prod"
                APIGEE_ORG="$DEFAULT_APIGEE_ORG"
              # All other branches are deployed as separate proxies with suffix in the test environment
              else
                APIGEE_DEPLOYMENT_SUFFIX=${CIRCLE_BRANCH// /-} 
                APIGEE_ENV="$DEFAULT_APIGEE_ENV"
                APIGEE_ORG="$DEFAULT_APIGEE_ORG"
              fi
            fi

            # Generate SA file from project variable
            cd /root/project
            echo $GCP_SERVICE_ACCOUNT > sa.json
      - run:
          name: mvn-deploy-config
          command: |
            sed -i "s/target_apigee_env/$APIGEE_ENV/g" ./EdgeConfig/edge.json
            mvn install -Pgoogleapi -Dapigee.org=$APIGEE_ORG -Denv=$APIGEE_ENV -Dsa=sa.json -Dapigee.config.file=./EdgeConfig/edge.json -Dapigee.config.options=update
      - run:
          name: mvn-package-proxy
          command: |
            if [ "$AUTHOR_EMAIL" == "" ]; then AUTHOR_EMAIL="$GITLAB_USER_EMAIL"; fi
            mvn process-resources -P$API_VERSION -Dcommit=$GIT_COMMIT -Dbranch=$GIT_BRANCH -Dauthor=$AUTHOR_EMAIL -Ddeployment.suffix=$APIGEE_DEPLOYMENT_SUFFIX
      - run:
          name: mvn-config-proxy
          command: |
            mvn apigee-enterprise:configure -P$API_VERSION -Dorg=$APIGEE_ORG -Denv=$APIGEE_ENV  -Ddeployment.suffix=$APIGEE_DEPLOYMENT_SUFFIX 
      - run:
          name: mvn-deploy-proxy
          command: |
            mvn apigee-enterprise:deploy -Pgoogleapi -Denv=$APIGEE_ENV -Dsa=sa.json -Dorg=$APIGEE_ORG -Ddeployment.suffix=$APIGEE_BUILD_DEPLOYMENT_SUFFIX 
          
workflows:
  version: 2
  apigee-deployment-and-tests:
    jobs:
      - deploy_apigee
